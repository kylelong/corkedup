{"ast":null,"code":"var assert = require('assert');\n\nvar fs = require('fs');\n\nvar mime = require('mime');\n\nvar util = require('util');\n\nvar MAX_FILE_SIZE_BYTES = 15 * 1024 * 1024;\nvar MAX_FILE_CHUNK_BYTES = 5 * 1024 * 1024;\n/**\n * FileUploader class used to upload a file to twitter via the /media/upload (chunked) API.\n * Usage:\n *   var fu = new FileUploader({ file_path: '/foo/bar/baz.mp4' }, twit);\n *   fu.upload(function (err, bodyObj, resp) {\n *     console.log(err, bodyObj);\n *   })\n *\n * @param  {Object}         params  Object of the form { file_path: String }.\n * @param  {Twit(object)}   twit    Twit instance.\n */\n\nvar FileUploader = function (params, twit) {\n  assert(params);\n  assert(params.file_path, 'Must specify `file_path` to upload a file. Got: ' + params.file_path + '.');\n  var self = this;\n  self._file_path = params.file_path;\n  self._twit = twit;\n  self._isUploading = false;\n  self._isFileStreamEnded = false;\n  self._isSharedMedia = !!params.shared;\n};\n/**\n * Upload a file to Twitter via the /media/upload (chunked) API.\n *\n * @param  {Function} cb function (err, data, resp)\n */\n\n\nFileUploader.prototype.upload = function (cb) {\n  var self = this; // Send INIT command with file info and get back a media_id_string we can use to APPEND chunks to it.\n\n  self._initMedia(function (err, bodyObj, resp) {\n    if (err) {\n      cb(err);\n      return;\n    } else {\n      var mediaTmpId = bodyObj.media_id_string;\n      var chunkNumber = 0;\n      var mediaFile = fs.createReadStream(self._file_path, {\n        highWatermark: MAX_FILE_CHUNK_BYTES\n      });\n      mediaFile.on('data', function (chunk) {\n        // Pause our file stream from emitting `data` events until the upload of this chunk completes.\n        // Any data that becomes available will remain in the internal buffer.\n        mediaFile.pause();\n        self._isUploading = true;\n\n        self._appendMedia(mediaTmpId, chunk.toString('base64'), chunkNumber, function (err, bodyObj, resp) {\n          self._isUploading = false;\n\n          if (err) {\n            cb(err);\n          } else {\n            if (self._isUploadComplete()) {\n              // We've hit the end of our stream; send FINALIZE command.\n              self._finalizeMedia(mediaTmpId, cb);\n            } else {\n              // Tell our file stream to start emitting `data` events again.\n              chunkNumber++;\n              mediaFile.resume();\n            }\n          }\n        });\n      });\n      mediaFile.on('end', function () {\n        // Mark our file streaming complete, and if done, send FINALIZE command.\n        self._isFileStreamEnded = true;\n\n        if (self._isUploadComplete()) {\n          self._finalizeMedia(mediaTmpId, cb);\n        }\n      });\n    }\n  });\n};\n\nFileUploader.prototype._isUploadComplete = function () {\n  return !this._isUploading && this._isFileStreamEnded;\n};\n/**\n * Send FINALIZE command for media object with id `media_id`.\n *\n * @param  {String}   media_id\n * @param  {Function} cb\n */\n\n\nFileUploader.prototype._finalizeMedia = function (media_id, cb) {\n  var self = this;\n\n  self._twit.post('media/upload', {\n    command: 'FINALIZE',\n    media_id: media_id\n  }, cb);\n};\n/**\n * Send APPEND command for media object with id `media_id`.\n * Append the chunk to the media object, then resume streaming our mediaFile.\n *\n * @param  {String}   media_id        media_id_string received from Twitter after sending INIT comand.\n * @param  {String}   chunk_part      Base64-encoded String chunk of the media file.\n * @param  {Number}   segment_index   Index of the segment.\n * @param  {Function} cb\n */\n\n\nFileUploader.prototype._appendMedia = function (media_id_string, chunk_part, segment_index, cb) {\n  var self = this;\n\n  self._twit.post('media/upload', {\n    command: 'APPEND',\n    media_id: media_id_string.toString(),\n    segment_index: segment_index,\n    media: chunk_part\n  }, cb);\n};\n/**\n * Send INIT command for our underlying media object.\n *\n * @param  {Function} cb\n */\n\n\nFileUploader.prototype._initMedia = function (cb) {\n  var self = this;\n  var mediaType = mime.lookup(self._file_path);\n  var mediaFileSizeBytes = fs.statSync(self._file_path).size;\n  var shared = self._isSharedMedia;\n  var media_category = 'tweet_image';\n\n  if (mediaType.toLowerCase().indexOf('gif') > -1) {\n    media_category = 'tweet_gif';\n  } else if (mediaType.toLowerCase().indexOf('video') > -1) {\n    media_category = 'tweet_video';\n  } // Check the file size - it should not go over 15MB for video.\n  // See https://dev.twitter.com/rest/reference/post/media/upload-chunked\n\n\n  if (mediaFileSizeBytes < MAX_FILE_SIZE_BYTES) {\n    self._twit.post('media/upload', {\n      'command': 'INIT',\n      'media_type': mediaType,\n      'total_bytes': mediaFileSizeBytes,\n      'shared': shared,\n      'media_category': media_category\n    }, cb);\n  } else {\n    var errMsg = util.format('This file is too large. Max size is %dB. Got: %dB.', MAX_FILE_SIZE_BYTES, mediaFileSizeBytes);\n    cb(new Error(errMsg));\n  }\n};\n\nmodule.exports = FileUploader;","map":{"version":3,"sources":["/Users/kylelong/corkedup/node_modules/twit/lib/file_uploader.js"],"names":["assert","require","fs","mime","util","MAX_FILE_SIZE_BYTES","MAX_FILE_CHUNK_BYTES","FileUploader","params","twit","file_path","self","_file_path","_twit","_isUploading","_isFileStreamEnded","_isSharedMedia","shared","prototype","upload","cb","_initMedia","err","bodyObj","resp","mediaTmpId","media_id_string","chunkNumber","mediaFile","createReadStream","highWatermark","on","chunk","pause","_appendMedia","toString","_isUploadComplete","_finalizeMedia","resume","media_id","post","command","chunk_part","segment_index","media","mediaType","lookup","mediaFileSizeBytes","statSync","size","media_category","toLowerCase","indexOf","errMsg","format","Error","module","exports"],"mappings":"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","sourcesContent":["var assert = require('assert');\nvar fs = require('fs');\nvar mime = require('mime');\nvar util = require('util');\n\nvar MAX_FILE_SIZE_BYTES = 15 * 1024 * 1024;\nvar MAX_FILE_CHUNK_BYTES = 5 * 1024 * 1024;\n\n/**\n * FileUploader class used to upload a file to twitter via the /media/upload (chunked) API.\n * Usage:\n *   var fu = new FileUploader({ file_path: '/foo/bar/baz.mp4' }, twit);\n *   fu.upload(function (err, bodyObj, resp) {\n *     console.log(err, bodyObj);\n *   })\n *\n * @param  {Object}         params  Object of the form { file_path: String }.\n * @param  {Twit(object)}   twit    Twit instance.\n */\nvar FileUploader = function (params, twit) {\n  assert(params)\n  assert(params.file_path, 'Must specify `file_path` to upload a file. Got: ' + params.file_path + '.')\n  var self = this;\n  self._file_path = params.file_path;\n  self._twit = twit;\n  self._isUploading = false;\n  self._isFileStreamEnded = false;\n  self._isSharedMedia = !!params.shared;\n}\n\n/**\n * Upload a file to Twitter via the /media/upload (chunked) API.\n *\n * @param  {Function} cb function (err, data, resp)\n */\nFileUploader.prototype.upload = function (cb) {\n  var self = this;\n\n  // Send INIT command with file info and get back a media_id_string we can use to APPEND chunks to it.\n  self._initMedia(function (err, bodyObj, resp) {\n    if (err) {\n      cb(err);\n      return;\n    } else {\n      var mediaTmpId = bodyObj.media_id_string;\n      var chunkNumber = 0;\n      var mediaFile = fs.createReadStream(self._file_path, { highWatermark: MAX_FILE_CHUNK_BYTES });\n\n      mediaFile.on('data', function (chunk) {\n        // Pause our file stream from emitting `data` events until the upload of this chunk completes.\n        // Any data that becomes available will remain in the internal buffer.\n        mediaFile.pause();\n        self._isUploading = true;\n\n        self._appendMedia(mediaTmpId, chunk.toString('base64'), chunkNumber, function (err, bodyObj, resp) {\n          self._isUploading = false;\n          if (err) {\n            cb(err);\n          } else {\n            if (self._isUploadComplete()) {\n              // We've hit the end of our stream; send FINALIZE command.\n              self._finalizeMedia(mediaTmpId, cb);\n            } else {\n              // Tell our file stream to start emitting `data` events again.\n              chunkNumber++;\n              mediaFile.resume();\n            }\n          }\n        });\n      });\n\n      mediaFile.on('end', function () {\n        // Mark our file streaming complete, and if done, send FINALIZE command.\n        self._isFileStreamEnded = true;\n        if (self._isUploadComplete()) {\n          self._finalizeMedia(mediaTmpId, cb);\n        }\n      });\n    }\n  })\n}\n\nFileUploader.prototype._isUploadComplete = function () {\n  return !this._isUploading && this._isFileStreamEnded;\n}\n\n  /**\n   * Send FINALIZE command for media object with id `media_id`.\n   *\n   * @param  {String}   media_id\n   * @param  {Function} cb\n   */\nFileUploader.prototype._finalizeMedia = function(media_id, cb) {\n  var self = this;\n  self._twit.post('media/upload', {\n    command: 'FINALIZE',\n    media_id: media_id\n  }, cb);\n}\n\n  /**\n   * Send APPEND command for media object with id `media_id`.\n   * Append the chunk to the media object, then resume streaming our mediaFile.\n   *\n   * @param  {String}   media_id        media_id_string received from Twitter after sending INIT comand.\n   * @param  {String}   chunk_part      Base64-encoded String chunk of the media file.\n   * @param  {Number}   segment_index   Index of the segment.\n   * @param  {Function} cb\n   */\nFileUploader.prototype._appendMedia = function(media_id_string, chunk_part, segment_index, cb) {\n  var self = this;\n  self._twit.post('media/upload', {\n    command: 'APPEND',\n    media_id: media_id_string.toString(),\n    segment_index: segment_index,\n    media: chunk_part,\n  }, cb);\n}\n\n/**\n * Send INIT command for our underlying media object.\n *\n * @param  {Function} cb\n */\nFileUploader.prototype._initMedia = function (cb) {\n  var self = this;\n  var mediaType = mime.lookup(self._file_path);\n  var mediaFileSizeBytes = fs.statSync(self._file_path).size;\n  var shared = self._isSharedMedia;\n  var media_category = 'tweet_image';\n\n  if (mediaType.toLowerCase().indexOf('gif') > -1) {\n    media_category = 'tweet_gif';\n  } else if (mediaType.toLowerCase().indexOf('video') > -1) {\n    media_category = 'tweet_video';\n  }\n\n  // Check the file size - it should not go over 15MB for video.\n  // See https://dev.twitter.com/rest/reference/post/media/upload-chunked\n  if (mediaFileSizeBytes < MAX_FILE_SIZE_BYTES) {\n    self._twit.post('media/upload', {\n      'command': 'INIT',\n      'media_type': mediaType,\n      'total_bytes': mediaFileSizeBytes,\n      'shared': shared,\n      'media_category': media_category\n    }, cb);\n  } else {\n    var errMsg = util.format('This file is too large. Max size is %dB. Got: %dB.', MAX_FILE_SIZE_BYTES, mediaFileSizeBytes);\n    cb(new Error(errMsg));\n  }\n}\n\nmodule.exports = FileUploader\n"]},"metadata":{},"sourceType":"script"}